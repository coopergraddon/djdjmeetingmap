<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DJ DJ LLC - Property Management</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-green: #1e4d4b;
            --secondary-green: #2a6a67;
            --light-green: #3a7b78;
            --accent-green: #4a8d8a;
            --bg-green: #f0f9f8;
            --text-dark: #1e4d4b;
        }
        
        body {
            background: linear-gradient(135deg, #f0f9f8 0%, #ffffff 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px rgba(30, 77, 75, 0.15);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .property-card {
            transition: all 0.3s ease;
            border-left: 4px solid var(--accent-green);
        }
        
        .property-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(30, 77, 75, 0.1);
            border-left-color: var(--primary-green);
        }
        
        .phase-sheetrock { background: linear-gradient(135deg, #8B5CF6, #A855F7); color: white; }
        .phase-flatwork { background: linear-gradient(135deg, #374151, #4B5563); color: white; }
        .phase-roof { background: linear-gradient(135deg, #0F766E, #14B8A6); color: white; }
        .phase-final { background: linear-gradient(135deg, #059669, #10B981); color: white; }
        .phase-design { background: linear-gradient(135deg, #2563EB, #3B82F6); color: white; }
        .phase-sold { background: linear-gradient(135deg, #16A34A, #22C55E); color: white; }
        .phase-listed { background: linear-gradient(135deg, #059669, #10B981); color: white; }
        .phase-pending { background: linear-gradient(135deg, #0891B2, #06B6D4); color: white; }
        .phase-delete { background: linear-gradient(135deg, #DC2626, #EF4444); color: white; }
        .phase-unknown { background: linear-gradient(135deg, #9CA3AF, #D1D5DB); color: white; }
        
        .stats-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(30, 77, 75, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(30, 77, 75, 0.2);
        }
        
        .nav-link {
            position: relative;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            color: var(--primary-green);
        }
        
        .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -4px;
            left: 50%;
            background: var(--accent-green);
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }
        
        .nav-link:hover::after {
            width: 100%;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fade-in {
            animation: fadeInUp 0.6s ease-out;
        }
        
        .hero-pattern {
            background-image: radial-gradient(circle at 1px 1px, rgba(30, 77, 75, 0.1) 1px, transparent 0);
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg shadow-lg relative overflow-hidden">
        <div class="absolute inset-0 hero-pattern opacity-50"></div>
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative">
            <div class="flex justify-between items-center h-20">
                <div class="flex items-center space-x-6">
                    <div class="flex items-center space-x-3">
                        <!-- DJ DJ LLC Logo - Your actual logo -->
                        <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-lg p-2">
                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE2MCIgdmlld0JveD0iMCAwIDI0MCAxNjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBkPSJNMCAxNjBMMTIwIDBMMjQwIDE2MEgxODBMMTIwIDgwTDYwIDE2MEgxMjBWMTIwSDIwMFYxNjBIMTYwVjEyMEgxMjBWMTYwSDYwTDEyMCA4MEwxODAgMTYwSDE0MEwxMjAgMTIwTDEwMCAxNjBIMFoiIGZpbGw9IiMxZTRkNGIiLz4KPC9zdmc+" 
                                 alt="DJ DJ LLC Logo" 
                                 class="w-full h-full object-contain">
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-white">DJ DJ LLC</div>
                            <div class="text-sm text-green-100">Property Management</div>
                        </div>
                    </div>
                    <div class="hidden md:flex items-center space-x-2 bg-white/20 backdrop-blur-sm px-4 py-2 rounded-full">
                        <i class="fas fa-link text-green-100"></i>
                        <span class="text-sm text-green-100 font-medium">ArcGIS Integrated System</span>
                    </div>
                </div>
                <nav class="flex space-x-8">
                    <button onclick="showPortfolioOverview()" class="nav-link text-white hover:text-green-100 font-medium py-2">
                        <i class="fas fa-chart-pie mr-2"></i>Dashboard
                    </button>
                    <button onclick="showAllProperties()" class="nav-link text-white hover:text-green-100 font-medium py-2">
                        <i class="fas fa-list mr-2"></i>All Properties
                    </button>
                    <button onclick="showPropertiesByCategory('Construction')" class="nav-link text-white hover:text-green-100 font-medium py-2">
                        <i class="fas fa-hard-hat mr-2"></i>In Construction
                    </button>
                    <button onclick="showPropertiesByCategory('Completed')" class="nav-link text-white hover:text-green-100 font-medium py-2">
                        <i class="fas fa-check-circle mr-2"></i>Completed
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Portfolio Overview -->
        <div id="portfolioOverview" class="space-y-10 animate-fade-in">
            <!-- Welcome Section -->
            <div class="text-center mb-12">
                <h1 class="text-4xl font-bold text-gray-900 mb-4">Property Portfolio Dashboard</h1>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto">Comprehensive management and tracking of all development projects across Bellingham and Blaine areas</p>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                <div class="stats-card card-hover rounded-2xl p-8 text-center cursor-pointer" onclick="showAllProperties()">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full gradient-bg flex items-center justify-center">
                        <i class="fas fa-home text-2xl text-white"></i>
                    </div>
                    <div class="text-3xl font-bold text-gray-900 mb-2">82</div>
                    <div class="text-gray-600 font-medium">Total Properties</div>
                    <div class="mt-2 text-sm text-green-600">Active Portfolio</div>
                </div>
                <div class="stats-card card-hover rounded-2xl p-8 text-center cursor-pointer" onclick="showPropertiesByCategory('Construction')">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center">
                        <i class="fas fa-hammer text-2xl text-white"></i>
                    </div>
                    <div class="text-3xl font-bold text-gray-900 mb-2">45</div>
                    <div class="text-gray-600 font-medium">In Construction</div>
                    <div class="mt-2 text-sm text-green-600">Active Development</div>
                </div>
                <div class="stats-card card-hover rounded-2xl p-8 text-center cursor-pointer" onclick="showPropertiesByCategory('Upcoming')">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                        <i class="fas fa-drafting-compass text-2xl text-white"></i>
                    </div>
                    <div class="text-3xl font-bold text-gray-900 mb-2">28</div>
                    <div class="text-gray-600 font-medium">Upcoming</div>
                    <div class="mt-2 text-sm text-blue-600">Future Development</div>
                </div>
                <div class="stats-card card-hover rounded-2xl p-8 text-center cursor-pointer" onclick="showPropertiesByCategory('Completed')">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center">
                        <i class="fas fa-check-circle text-2xl text-white"></i>
                    </div>
                    <div class="text-3xl font-bold text-gray-900 mb-2">9</div>
                    <div class="text-gray-600 font-medium">Completed</div>
                    <div class="mt-2 text-sm text-purple-600">Finished Projects</div>
                </div>
            </div>

            <!-- Charts and Activity Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                <!-- Phase Distribution Chart -->
                <div class="glass-effect rounded-2xl p-8 shadow-xl">
                    <div class="flex items-center justify-between mb-8">
                        <h2 class="text-2xl font-bold text-gray-900">Phase Distribution</h2>
                        <div class="p-3 rounded-full bg-gradient-to-br from-green-100 to-green-200">
                            <i class="fas fa-chart-pie text-green-600"></i>
                        </div>
                    </div>
                    <div class="relative h-80">
                        <canvas id="phaseChart"></canvas>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div class="glass-effect rounded-2xl p-8 shadow-xl">
                    <div class="flex items-center justify-between mb-8">
                        <h2 class="text-2xl font-bold text-gray-900">Recent Activity</h2>
                        <div class="p-3 rounded-full bg-gradient-to-br from-blue-100 to-blue-200">
                            <i class="fas fa-clock text-blue-600"></i>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div class="flex items-center space-x-4 p-4 rounded-xl bg-green-50 border border-green-100">
                            <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">2903 Hazelwood Dr</div>
                                <div class="text-sm text-gray-600">Successfully sold - Project completed</div>
                            </div>
                            <span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full">Sold</span>
                        </div>
                        <div class="flex items-center space-x-4 p-4 rounded-xl bg-blue-50 border border-blue-100">
                            <div class="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></div>
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">2615 Woburn St</div>
                                <div class="text-sm text-gray-600">Advanced to Sheetrock phase</div>
                            </div>
                            <span class="text-xs text-blue-600 bg-blue-100 px-2 py-1 rounded-full">Sheetrock</span>
                        </div>
                        <div class="flex items-center space-x-4 p-4 rounded-xl bg-purple-50 border border-purple-100">
                            <div class="w-3 h-3 bg-purple-500 rounded-full animate-pulse"></div>
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">Oceanside, Blaine</div>
                                <div class="text-sm text-gray-600">Entered design phase - Permits pending</div>
                            </div>
                            <span class="text-xs text-purple-600 bg-purple-100 px-2 py-1 rounded-full">Design</span>
                        </div>
                        <div class="flex items-center space-x-4 p-4 rounded-xl bg-yellow-50 border border-yellow-100">
                            <div class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse"></div>
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">System Update</div>
                                <div class="text-sm text-gray-600">Multiple new permits submitted this week</div>
                            </div>
                            <span class="text-xs text-yellow-600 bg-yellow-100 px-2 py-1 rounded-full">Update</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="glass-effect rounded-2xl p-8 shadow-xl">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-2xl font-bold text-gray-900">Quick Actions</h2>
                    <div class="p-3 rounded-full bg-gradient-to-br from-indigo-100 to-indigo-200">
                        <i class="fas fa-rocket text-indigo-600"></i>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <button onclick="window.open('https://experience.arcgis.com/experience/c69f053c68e84a0ab98bc80b00836949/', '_blank')" class="group btn-primary text-white px-8 py-6 rounded-xl font-semibold flex items-center justify-center space-x-3 shadow-lg">
                        <i class="fas fa-map-marked-alt text-xl group-hover:scale-110 transition-transform"></i>
                        <span>Open ArcGIS Map</span>
                    </button>
                    <button onclick="showPropertiesByCategory('Construction')" class="group bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-8 py-6 rounded-xl font-semibold flex items-center justify-center space-x-3 shadow-lg transition-all hover:scale-105">
                        <i class="fas fa-hard-hat text-xl group-hover:scale-110 transition-transform"></i>
                        <span>View Construction</span>
                    </button>
                    <button onclick="showAllProperties()" class="group bg-gradient-to-br from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white px-8 py-6 rounded-xl font-semibold flex items-center justify-center space-x-3 shadow-lg transition-all hover:scale-105">
                        <i class="fas fa-th-large text-xl group-hover:scale-110 transition-transform"></i>
                        <span>Browse All</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Property List View -->
        <div id="propertyListView" class="space-y-8 animate-fade-in" style="display: none;">
            <div class="flex justify-between items-center">
                <div>
                    <h1 id="listTitle" class="text-4xl font-bold text-gray-900 mb-2">All Properties</h1>
                    <p class="text-gray-600">Manage and track all development properties</p>
                </div>
                <button onclick="showPortfolioOverview()" class="btn-primary text-white px-6 py-3 rounded-xl font-semibold flex items-center space-x-2 shadow-lg">
                    <i class="fas fa-arrow-left"></i>
                    <span>Back to Dashboard</span>
                </button>
            </div>
            
            <!-- Search and Filter -->
            <div class="glass-effect rounded-2xl p-6 shadow-lg">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1 relative">
                        <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="searchInput" placeholder="Search by address, APN, or city..." class="w-full pl-12 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white/80">
                    </div>
                    <div class="relative">
                        <i class="fas fa-filter absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <select id="phaseFilter" class="pl-12 pr-8 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 bg-white/80 min-w-[200px]">
                            <option value="">All Phases</option>
                            <option value="Sheetrock">Sheetrock</option>
                            <option value="Flatwork">Flatwork</option>
                            <option value="Roof">Roof</option>
                            <option value="Final">Final</option>
                            <option value="Design">Design</option>
                            <option value="Sold">Sold</option>
                            <option value="Listed">Listed</option>
                            <option value="Pending">Pending</option>
                            <option value="Delete">Delete</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Properties Grid -->
            <div id="propertiesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Properties will be inserted here -->
            </div>
        </div>

        <!-- Property Detail View -->
        <div id="propertyDetail" class="space-y-8 animate-fade-in" style="display: none;">
            <div class="flex justify-between items-center">
                <div>
                    <h1 id="detailTitle" class="text-4xl font-bold text-gray-900 mb-2">Property Details</h1>
                    <p class="text-gray-600">Comprehensive property information and project status</p>
                </div>
                <button onclick="goBack()" class="btn-primary text-white px-6 py-3 rounded-xl font-semibold flex items-center space-x-2 shadow-lg">
                    <i class="fas fa-arrow-left"></i>
                    <span>Back</span>
                </button>
            </div>
            
            <div id="detailContent">
                <!-- Detail content will be inserted here -->
            </div>
        </div>
    </main>

    <script>
        // Real property data from your CSV files - CORRECTED ADDRESSES
        const allProperties = [
            // Construction Properties from CSV - CORRECTED
            // Add timing and financial data from CSV
            {
                "id": "property-3803204881530000",
                "address": "2615 Woburn St",
                "apn": "3803204881530000",
                "phase": "Sheetrock",
                "type": "Single Family",
                "city": "Bellingham",
                "permit": "BLD2024-0349",
                "sqft": "2,438",
                "client": "GM/ DJ & DJ",
                "startDate": "4/3/2025",
                "deadline": "8/18/2025",
                "notes": "Primary residence construction",
                "permitSubmitted": "3/8/2024",
                "permitIssued": "10/25/2024",
                "daysToComplete": "137",
                "estimatedDaysToComplete": "137",
                "financialInstitution": "N/A",
                "category": "Construction"
            },
            {
                "id": "property-3951021720430000",
                "address": "6920 Holeman Ave",
                "apn": "3951021720430000",
                "phase": "Sheetrock",
                "type": "Single Family",
                "city": "Bellingham",
                "permit": "BLD2024-0351",
                "sqft": "2,438",
                "client": "GM/ DJ & DJ",
                "startDate": "4/3/2025",
                "deadline": "8/18/2025",
                "notes": "Single family residence",
                "permitSubmitted": "3/8/2024",
                "permitIssued": "10/25/2024",
                "daysToComplete": "137",
                "estimatedDaysToComplete": "140",
                "financialInstitution": "N/A",
                "category": "Construction"
            },
            {
                "id": "property-3901274200350000",
                "address": "3390 Unick Road",
                "apn": "3901274200350000",
                "phase": "Sheetrock",
                "type": "Single Family",
                "city": "Bellingham",
                "permit": "",
                "sqft": "",
                "client": "GM/ DJ & DJ",
                "startDate": "",
                "deadline": "",
                "notes": "Single family residence construction",
                "permitSubmitted": "",
                "permitIssued": "",
                "category": "Construction"
            },
            {
                "id": "property-3803041991010000",
                "address": "4575 Vacca Ln",
                "apn": "3803041991010000",
                "phase": "Flatwork",
                "type": "Single Family",
                "city": "Bellingham",
                "permit": "",
                "sqft": "",
                "client": "",
                "startDate": "",
                "deadline": "",
                "notes": "Concrete and foundation work in progress",
                "permitSubmitted": "",
                "permitIssued": "",
                "category": "Construction"
            },
            {
                "id": "property-3702013190480000",
                "address": "1611 Larrabee Ave",
                "apn": "3702013190480000",
                "phase": "Sheetrock",
                "type": "Single Family",
                "city": "Bellingham",
                "permit": "",
                "sqft": "",
                "client": "",
                "startDate": "",
                "deadline": "",
                "notes": "Sheetrock phase in progress",
                "permitSubmitted": "",
                "permitIssued": "",
                "category": "Construction"
            },
            {
                "id": "property-3702013220480000",
                "address": "1615 Larrabee Ave",
                "apn": "3702013220480000",
                "phase": "Sheetrock",
                "type": "Single Family",
                "city": "Bellingham",
                "permit": "",
                "sqft": "",
                "client": "",
                "startDate": "",
                "deadline": "",
                "notes": "Sheetrock phase in progress",
                "permitSubmitted": "",
                "permitIssued": "",
                "category": "Construction"
            },
            {
                "id": "property-3702013260480000",
                "address": "1619 Larrabee Ave",
                "apn": "3702013260480000",
                "phase": "Sheetrock",
                "type": "Single Family",
                "city": "Bellingham",
                "permit": "",
                "sqft": "",
                "client": "",
                "startDate": "",
                "deadline": "",
                "notes": "Sheetrock phase in progress",
                "permitSubmitted": "",
                "permitIssued": "",
                "category": "Construction"
            },
            {
                "id": "property-3702013300480000",
                "address": "1623 Larrabee Ave",
                "apn": "3702013300480000",
                "phase": "Sheetrock",
                "type": "Single Family",
                "city": "Bellingham",
                "permit": "",
                "sqft": "",
                "client": "",
                "startDate": "",
                "deadline": "",
                "notes": "Sheetrock phase in progress",
                "permitSubmitted": "",
                "permitIssued": "",
                "category": "Construction"
            },
            {
                "id": "property-3803195231630000",
                "address": "2626 Iron St",
                "apn": "3803195231630000",
                "phase": "Sheetrock",
                "type": "Single Family",
                "city": "Bellingham",
                "permit": "",
                "sqft": "",
                "client": "",
                "startDate": "",
                "deadline": "",
                "notes": "Sheetrock phase in progress",
                "permitSubmitted": "",
                "permitIssued": "",
                "category": "Construction"
            },
            {
                "id": "property-4001035222100000",
                "address": "9525 Valley View",
                "apn": "4001035222100000",
                "phase": "Roof",
                "type": "Single Family",
                "city": "Blaine",
                "permit": "",
                "sqft": "",
                "client": "",
                "startDate": "",
                "deadline": "",
                "notes": "Roofing phase in progress",
                "permitSubmitted": "",
                "permitIssued": "",
                "category": "Construction"
            },
            {
                "id": "property-4001192524250000",
                "address": "4710 Sagebrush Lane",
                "apn": "4001192524250000",
                "phase": "Sheetrock",
                "type": "Single Family",
                "city": "Blaine",
                "permit": "",
                "sqft": "",
                "client": "",
                "startDate": "",
                "deadline": "",
                "notes": "Sheetrock phase in progress",
                "permitSubmitted": "",
                "permitIssued": "",
                "category": "Construction"
            },
            {
                "id": "property-3803284510440000",
                "address": "1324 Birch St",
                "apn": "3803284510440000",
                "phase": "Roof",
                "type": "Single Family",
                "city": "Bellingham",
                "permit": "",
                "sqft": "",
                "client": "",
                "startDate": "",
                "deadline": "",
                "notes": "Roofing phase in progress",
                "permitSubmitted": "",
                "permitIssued": "",
                "category": "Construction"
            },
            {
                "id": "property-4004294303970000",
                "address": "801 E 5th St",
                "apn": "4004294303970000",
                "phase": "Final",
                "type": "Single Family",
                "city": "Blaine",
                "permit": "",
                "sqft": "",
                "client": "",
                "startDate": "",
                "deadline": "",
                "notes": "Final inspection and completion",
                "permitSubmitted": "",
                "permitIssued": "",
                "category": "Construction"
            },
            {
                "id": "property-4004294303900000",
                "address": "721 E 5th St",
                "apn": "4004294303900000",
                "phase": "Sheetrock",
                "type": "Single Family",
                "city": "Blaine",
                "permit": "",
                "sqft": "",
                "client": "",
                "startDate": "",
                "deadline": "",
                "notes": "Sheetrock phase in progress",
                "permitSubmitted": "",
                "permitIssued": "",
                "category": "Construction"
            },
            {
                "id": "property-4101324331930000",
                "address": "2895 Oleander Lane",
                "apn": "4101324331930000",
                "phase": "Flatwork",
                "type": "Single Family",
                "city": "Blaine",
                "permit": "",
                "sqft": "",
                "client": "",
                "startDate": "",
                "deadline": "",
                "notes": "Flatwork phase in progress",
                "permitSubmitted": "",
                "permitIssued": "",
                "category": "Construction"
            },
            // Upcoming Properties from CSV - CORRECTED
            {
                "id": "property-4101314601950000",
                "address": "Oceanside",
                "apn": "4101314601950000",
                "phase": "Design",
                "type": "Residential",
                "city": "Blaine",
                "permit": "",
                "sqft": "",
                "client": "Multiple",
                "notes": "Kharis never got comments - Very close to resolving",
                "category": "Upcoming"
            },
            {
                "id": "property-4101314901910000",
                "address": "Kenai",
                "apn": "4101314901910000",
                "phase": "Design",
                "type": "Residential",
                "city": "Blaine",
                "permit": "",
                "sqft": "",
                "client": "Multiple",
                "notes": "All edits from previous approval letters complete - working on plat map",
                "category": "Upcoming"
            },
            {
                "id": "property-4001062791610000",
                "address": "Mary Ave",
                "apn": "4001062791610000",
                "phase": "Design",
                "type": "Residential",
                "city": "Blaine",
                "permit": "",
                "sqft": "",
                "client": "",
                "notes": "Design phase development",
                "category": "Upcoming"
            },
            {
                "id": "property-3803205570260000",
                "address": "2333 Yew St",
                "apn": "3803205570260000",
                "phase": "Design",
                "type": "Residential",
                "city": "Bellingham",
                "permit": "",
                "sqft": "",
                "client": "",
                "notes": "Design phase development",
                "category": "Upcoming"
            },
            {
                "id": "property-3803205570200000",
                "address": "2325 Yew St",
                "apn": "3803205570200000",
                "phase": "Design",
                "type": "Residential",
                "city": "Bellingham",
                "permit": "",
                "sqft": "",
                "client": "",
                "notes": "Design phase development",
                "category": "Upcoming"
            },
            {
                "id": "property-3803190161450000",
                "address": "1004 W North St",
                "apn": "3803190161450000",
                "phase": "Design",
                "type": "Residential",
                "city": "Bellingham",
                "permit": "",
                "sqft": "",
                "client": "",
                "notes": "Design phase development",
                "category": "Upcoming"
            },
            {
                "id": "property-4051014745510000",
                "address": "715 Peace Portal",
                "apn": "4051014745510000",
                "phase": "Design",
                "type": "Residential",
                "city": "Blaine",
                "permit": "",
                "sqft": "",
                "client": "",
                "notes": "Design phase development",
                "category": "Upcoming"
            },
            // Completed Properties from CSV - CORRECTED
            {
                "id": "property-4101324351700000",
                "address": "2903 Hazelwood Dr",
                "apn": "4101324351700000",
                "phase": "Sold",
                "type": "Ridge II- SFR",
                "city": "Blaine",
                "permit": "23253",
                "sqft": "2108",
                "client": "DJDJ/BB",
                "startDate": "10/24/2024",
                "completed": "1/30/2025",
                "notes": "Successfully completed and sold",
                "daysToComplete": "152",
                "estimatedDaysToComplete": "150",
                "financialInstitution": "WECU",
                "category": "Completed"
            },
            {
                "id": "property-4101324261840000",
                "address": "2880 Hazelwood Dr",
                "apn": "4101324261840000",
                "phase": "Listed",
                "type": "Ridge II- SFR",
                "city": "Blaine",
                "permit": "24053",
                "sqft": "1798",
                "client": "Jubilee Star",
                "startDate": "12/17/2024",
                "completed": "12/18/2024",
                "notes": "Completed and listed for sale",
                "category": "Completed"
            },
            {
                "id": "property-4101323861700000",
                "address": "2791 Hazelwood Dr",
                "apn": "4101323861700000",
                "phase": "Listed",
                "type": "Ridge II- SFR",
                "city": "Blaine",
                "permit": "24067",
                "sqft": "1794",
                "client": "J. Hart",
                "startDate": "2/6/2025",
                "notes": "Punchlist completed, ready for sale",
                "category": "Completed"
            },
            {
                "id": "property-4101324702170000",
                "address": "200 Sweet Gum Dr",
                "apn": "4101324702170000",
                "phase": "Listed",
                "type": "Ridge II- SFR",
                "city": "Blaine",
                "permit": "24074",
                "sqft": "2,122",
                "client": "DJVW",
                "startDate": "2/24/2025",
                "completed": "4/1/2025",
                "notes": "Completed and listed for sale",
                "category": "Completed"
            },
            {
                "id": "property-4101324672230000",
                "address": "180 Sweet Gum Dr",
                "apn": "4101324672230000",
                "phase": "Sold",
                "type": "Ridge II- SFR",
                "city": "Blaine",
                "permit": "24082",
                "sqft": "1,794",
                "client": "DJVW",
                "startDate": "2/24/2025",
                "completed": "4/16/2025",
                "notes": "Successfully sold",
                "category": "Completed"
            },
            {
                "id": "property-4101324741840000",
                "address": "282 Sweet Gum Dr",
                "apn": "4101324741840000",
                "phase": "Sold",
                "type": "Ridge II- SFR",
                "city": "Blaine",
                "permit": "",
                "sqft": "2,358",
                "client": "DJVW",
                "startDate": "4/10/2025",
                "completed": "4/13/2025",
                "notes": "Successfully sold",
                "category": "Completed"
            },
            {
                "id": "property-4101324732050000",
                "address": "230 Sweet Gum Dr",
                "apn": "4101324732050000",
                "phase": "Sold",
                "type": "Ridge II- SFR",
                "city": "Blaine",
                "permit": "24073",
                "sqft": "2,108",
                "client": "DJVW",
                "startDate": "4/10/2025",
                "completed": "",
                "notes": "Successfully sold",
                "category": "Completed"
            },
            {
                "id": "property-4101324712110000",
                "address": "214 Sweet Gum Dr",
                "apn": "4101324712110000",
                "phase": "Pending",
                "type": "Ridge II- SFR",
                "city": "Blaine",
                "permit": "24081",
                "sqft": "1,798",
                "client": "DJVW",
                "startDate": "3/20/2025",
                "completed": "7/25/2025",
                "notes": "Sale pending",
                "category": "Completed"
            },
            {
                "id": "property-4101323991930000",
                "address": "2823 Oleander Lane",
                "apn": "4101323991930000",
                "phase": "Listed",
                "type": "Ridge II- SFR",
                "city": "Blaine",
                "permit": "24172",
                "sqft": "1,798",
                "client": "JM/DJDJ",
                "startDate": "6/27/2025",
                "completed": "",
                "notes": "Completed and listed for sale",
                "category": "Completed"
            }
        ];

        let currentView = 'overview';
        let filteredProperties = [...allProperties];

        // Initialize phase chart with enhanced styling
        function initializePhaseChart() {
            const ctx = document.getElementById('phaseChart').getContext('2d');
            
            // Count properties by phase from real data
            const phaseCounts = {};
            allProperties.forEach(property => {
                phaseCounts[property.phase] = (phaseCounts[property.phase] || 0) + 1;
            });

            console.log('Phase counts:', phaseCounts);

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(phaseCounts),
                    datasets: [{
                        data: Object.values(phaseCounts),
                        backgroundColor: [
                            '#8B5CF6', // Purple - Sheetrock
                            '#374151', // Dark Gray - Flatwork  
                            '#0F766E', // Teal - Roof
                            '#059669', // Green - Final
                            '#2563EB', // Blue - Design
                            '#16A34A', // Dark Green - Sold
                            '#059669', // Green - Listed
                            '#0891B2', // Light Blue - Pending
                            '#DC2626', // Red - Delete
                            '#9CA3AF'  // Light Gray - Other
                        ],
                        borderWidth: 3,
                        borderColor: '#ffffff',
                        hoverBorderWidth: 4,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 25,
                                usePointStyle: true,
                                font: {
                                    size: 13,
                                    weight: '500'
                                },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return {
                                                text: `${label} (${percentage}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1e4d4b',
                            bodyColor: '#374151',
                            borderColor: '#e5e7eb',
                            borderWidth: 1,
                            cornerRadius: 12,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} properties (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        duration: 1500,
                        easing: 'easeOutQuart'
                    },
                    hover: {
                        mode: 'nearest',
                        intersect: true
                    }
                }
            });
        }

        // Get phase color class with enhanced styling
        function getPhaseColor(phase) {
            const colors = {
                'Sheetrock': 'phase-sheetrock',
                'Flatwork': 'phase-flatwork',
                'Roof': 'phase-roof',
                'Final': 'phase-final',
                'Design': 'phase-design',
                'Sold': 'phase-sold',
                'Listed': 'phase-listed',
                'Pending': 'phase-pending',
                'Delete': 'phase-delete',
                'Unknown': 'phase-unknown'
            };
            return colors[phase] || 'bg-gray-500 text-white';
        }

        // Create enhanced property card
        function createPropertyCard(property) {
            const phaseIcon = {
                'Sheetrock': 'fas fa-paint-roller',
                'Flatwork': 'fas fa-hammer',
                'Roof': 'fas fa-home',
                'Final': 'fas fa-check-circle',
                'Design': 'fas fa-drafting-compass',
                'Sold': 'fas fa-dollar-sign',
                'Listed': 'fas fa-tag',
                'Pending': 'fas fa-clock',
                'Delete': 'fas fa-trash'
            };

            return '<div class="property-card glass-effect rounded-2xl overflow-hidden shadow-lg">' +
                '<div class="p-6">' +
                    '<div class="flex justify-between items-start mb-6">' +
                        '<div class="flex-1">' +
                            '<h3 class="text-xl font-bold text-gray-900 mb-2">' + property.address + '</h3>' +
                            '<div class="flex items-center space-x-2 text-sm text-gray-600">' +
                                '<i class="fas fa-map-marker-alt"></i>' +
                                '<span>' + property.city + '</span>' +
                            '</div>' +
                        '</div>' +
                        '<div class="flex flex-col items-end space-y-2">' +
                            '<span class="px-3 py-2 text-sm font-semibold rounded-xl ' + getPhaseColor(property.phase) + ' flex items-center space-x-2">' +
                                '<i class="' + (phaseIcon[property.phase] || 'fas fa-info') + '"></i>' +
                                '<span>' + property.phase + '</span>' +
                            '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="space-y-3 mb-6">' +
                        '<div class="flex justify-between items-center">' +
                            '<span class="text-gray-600 flex items-center space-x-2">' +
                                '<i class="fas fa-id-card text-sm"></i>' +
                                '<span>APN:</span>' +
                            '</span>' +
                            '<span class="font-mono text-sm font-medium">' + property.apn + '</span>' +
                        '</div>' +
                        '<div class="flex justify-between items-center">' +
                            '<span class="text-gray-600 flex items-center space-x-2">' +
                                '<i class="fas fa-building text-sm"></i>' +
                                '<span>Type:</span>' +
                            '</span>' +
                            '<span class="font-medium">' + property.type + '</span>' +
                        '</div>' +
                        (property.permit ? '<div class="flex justify-between items-center">' +
                            '<span class="text-gray-600 flex items-center space-x-2">' +
                                '<i class="fas fa-file-alt text-sm"></i>' +
                                '<span>Permit:</span>' +
                            '</span>' +
                            '<span class="font-medium">' + property.permit + '</span>' +
                        '</div>' : '') +
                        (property.sqft ? '<div class="flex justify-between items-center">' +
                            '<span class="text-gray-600 flex items-center space-x-2">' +
                                '<i class="fas fa-ruler-combined text-sm"></i>' +
                                '<span>Sq Ft:</span>' +
                            '</span>' +
                            '<span class="font-medium">' + property.sqft + '</span>' +
                        '</div>' : '') +
                    '</div>' +
                    '<div class="flex gap-3">' +
                        '<button onclick="event.stopPropagation(); handleViewDetails(\'' + property.id + '\')" class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-4 py-3 rounded-xl font-semibold transition-all duration-300 flex items-center justify-center space-x-2">' +
                            '<i class="fas fa-info-circle"></i>' +
                            '<span>Details</span>' +
                        '</button>' +
                        '<button onclick="event.stopPropagation(); handleViewArcGIS(\'' + property.apn + '\')" class="flex-1 btn-primary text-white px-4 py-3 rounded-xl font-semibold transition-all duration-300 flex items-center justify-center space-x-2">' +
                            '<i class="fas fa-map-marked-alt"></i>' +
                            '<span>Map</span>' +
                        '</button>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }

        // Enhanced detail view
        function handleViewDetails(propertyId) {
            console.log('Handle view details called for:', propertyId);
            
            const property = allProperties.find(p => p.id === propertyId);
            if (!property) {
                console.log('Property not found:', propertyId);
                return;
            }
            
            console.log('Found property:', property);
            
            // Hide all views
            document.getElementById('portfolioOverview').style.display = 'none';
            document.getElementById('propertyListView').style.display = 'none';
            document.getElementById('propertyDetail').style.display = 'block';
            
            // Update detail content with enhanced styling
            const detailContent = document.getElementById('detailContent');
            if (!detailContent) {
                console.error('detailContent element not found');
                return;
            }
            
            detailContent.innerHTML = 
                '<div class="space-y-8">' +
                    '<div class="grid grid-cols-1 md:grid-cols-3 gap-8">' +
                        '<div class="glass-effect rounded-2xl p-8 shadow-lg">' +
                            '<div class="flex items-center space-x-3 mb-6">' +
                                '<div class="p-3 rounded-xl bg-gradient-to-br from-blue-100 to-blue-200">' +
                                    '<i class="fas fa-info-circle text-blue-600"></i>' +
                                '</div>' +
                                '<h3 class="text-2xl font-bold text-gray-900">Property Information</h3>' +
                            '</div>' +
                            '<div class="space-y-4">' +
                                '<div class="flex justify-between items-center p-3 rounded-lg bg-gray-50">' +
                                    '<span class="text-gray-600 font-medium">Address:</span>' +
                                    '<span class="font-bold text-gray-900">' + property.address + '</span>' +
                                '</div>' +
                                '<div class="flex justify-between items-center p-3 rounded-lg bg-gray-50">' +
                                    '<span class="text-gray-600 font-medium">APN/Geo ID:</span>' +
                                    '<span class="font-mono font-bold text-gray-900">' + property.apn + '</span>' +
                                '</div>' +
                                '<div class="flex justify-between items-center p-3 rounded-lg bg-gray-50">' +
                                    '<span class="text-gray-600 font-medium">Phase:</span>' +
                                    '<span class="px-3 py-1 text-sm font-semibold rounded-lg ' + getPhaseColor(property.phase) + '">' + property.phase + '</span>' +
                                '</div>' +
                                '<div class="flex justify-between items-center p-3 rounded-lg bg-gray-50">' +
                                    '<span class="text-gray-600 font-medium">Property Type:</span>' +
                                    '<span class="font-bold text-gray-900">' + property.type + '</span>' +
                                '</div>' +
                                '<div class="flex justify-between items-center p-3 rounded-lg bg-gray-50">' +
                                    '<span class="text-gray-600 font-medium">City:</span>' +
                                    '<span class="font-bold text-gray-900">' + property.city + '</span>' +
                                '</div>' +
                                (property.sqft ? '<div class="flex justify-between items-center p-3 rounded-lg bg-gray-50">' +
                                    '<span class="text-gray-600 font-medium">Square Feet:</span>' +
                                    '<span class="font-bold text-gray-900">' + property.sqft + '</span>' +
                                '</div>' : '') +
                                (property.permit ? '<div class="flex justify-between items-center p-3 rounded-lg bg-gray-50">' +
                                    '<span class="text-gray-600 font-medium">Permit #:</span>' +
                                    '<span class="font-bold text-gray-900">' + property.permit + '</span>' +
                                '</div>' : '') +
                            '</div>' +
                        '</div>' +
                        
                        '<div class="glass-effect rounded-2xl p-8 shadow-lg">' +
                            '<div class="flex items-center space-x-3 mb-6">' +
                                '<div class="p-3 rounded-xl bg-gradient-to-br from-green-100 to-green-200">' +
                                    '<i class="fas fa-calendar-alt text-green-600"></i>' +
                                '</div>' +
                                '<h3 class="text-2xl font-bold text-gray-900">Project Timeline</h3>' +
                            '</div>' +
                            '<div class="space-y-4">' +
                                (property.permitSubmitted ? '<div class="flex justify-between items-center p-3 rounded-lg bg-gray-50">' +
                                    '<span class="text-gray-600 font-medium">Permit Submitted:</span>' +
                                    '<span class="font-bold text-gray-900">' + property.permitSubmitted + '</span>' +
                                '</div>' : '') +
                                (property.permitIssued ? '<div class="flex justify-between items-center p-3 rounded-lg bg-gray-50">' +
                                    '<span class="text-gray-600 font-medium">Permit Issued:</span>' +
                                    '<span class="font-bold text-gray-900">' + property.permitIssued + '</span>' +
                                '</div>' : '') +
                                (property.startDate ? '<div class="flex justify-between items-center p-3 rounded-lg bg-gray-50">' +
                                    '<span class="text-gray-600 font-medium">Start Date:</span>' +
                                    '<span class="font-bold text-gray-900">' + property.startDate + '</span>' +
                                '</div>' : '') +
                                (property.deadline ? '<div class="flex justify-between items-center p-3 rounded-lg bg-gray-50">' +
                                    '<span class="text-gray-600 font-medium">Target Completion:</span>' +
                                    '<span class="font-bold text-gray-900">' + property.deadline + '</span>' +
                                '</div>' : '') +
                                (property.completed ? '<div class="flex justify-between items-center p-3 rounded-lg bg-gray-50">' +
                                    '<span class="text-gray-600 font-medium">Completed:</span>' +
                                    '<span class="font-bold text-gray-900">' + property.completed + '</span>' +
                                '</div>' : '') +
                                (property.client ? '<div class="flex justify-between items-center p-3 rounded-lg bg-gray-50">' +
                                    '<span class="text-gray-600 font-medium">Client:</span>' +
                                    '<span class="font-bold text-gray-900">' + property.client + '</span>' +
                                '</div>' : '') +
                            '</div>' +
                        '</div>' +

                        '<div class="glass-effect rounded-2xl p-8 shadow-lg">' +
                            '<div class="flex items-center space-x-3 mb-6">' +
                                '<div class="p-3 rounded-xl bg-gradient-to-br from-yellow-100 to-yellow-200">' +
                                    '<i class="fas fa-clock text-yellow-600"></i>' +
                                '</div>' +
                                '<h3 class="text-2xl font-bold text-gray-900">Timeline & Finance</h3>' +
                            '</div>' +
                            '<div class="space-y-4">' +
                                (property.daysToComplete ? '<div class="flex justify-between items-center p-4 rounded-xl bg-gradient-to-r from-blue-50 to-blue-100 border-l-4 border-blue-500">' +
                                    '<span class="text-blue-700 font-semibold flex items-center space-x-2">' +
                                        '<i class="fas fa-calendar-day text-lg"></i>' +
                                        '<span>Current Length:</span>' +
                                    '</span>' +
                                    '<span class="font-bold text-blue-900 text-lg">' + property.daysToComplete + ' days</span>' +
                                '</div>' : '') +
                                (property.estimatedDaysToComplete ? '<div class="flex justify-between items-center p-3 rounded-lg bg-gray-50">' +
                                    '<span class="text-gray-600 font-medium">Est. Days to Complete:</span>' +
                                    '<span class="font-bold text-gray-900">' + property.estimatedDaysToComplete + ' days</span>' +
                                '</div>' : '') +
                                (property.financialInstitution ? '<div class="flex justify-between items-center p-3 rounded-lg bg-gray-50">' +
                                    '<span class="text-gray-600 font-medium">Financial Institution:</span>' +
                                    '<span class="font-bold text-gray-900">' + property.financialInstitution + '</span>' +
                                '</div>' : '') +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    
                    '<div class="glass-effect rounded-2xl p-8 shadow-lg">' +
                        '<div class="flex items-center space-x-3 mb-6">' +
                            '<div class="p-3 rounded-xl bg-gradient-to-br from-purple-100 to-purple-200">' +
                                '<i class="fas fa-sticky-note text-purple-600"></i>' +
                            '</div>' +
                            '<h3 class="text-2xl font-bold text-gray-900">Project Notes & Status</h3>' +
                        '</div>' +
                        '<div class="bg-gray-50 rounded-xl p-6">' +
                            '<p class="text-gray-700 leading-relaxed mb-4">' + (property.notes || 'No additional notes available.') + '</p>' +
                            '<div class="flex items-center space-x-3">' +
                                '<span class="text-gray-600 font-medium">Category:</span>' +
                                '<span class="inline-block px-4 py-2 text-sm font-semibold bg-gradient-to-r from-gray-100 to-gray-200 text-gray-800 rounded-lg">' + property.category + '</span>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    
                    '<div class="glass-effect rounded-2xl p-8 shadow-lg">' +
                        '<div class="flex items-center space-x-3 mb-6">' +
                            '<div class="p-3 rounded-xl bg-gradient-to-br from-indigo-100 to-indigo-200">' +
                                '<i class="fas fa-cogs text-indigo-600"></i>' +
                            '</div>' +
                            '<h3 class="text-2xl font-bold text-gray-900">Actions</h3>' +
                        '</div>' +
                        '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">' +
                            '<button onclick="handleViewArcGIS(\'' + property.apn + '\')" class="btn-primary text-white px-6 py-4 rounded-xl font-semibold transition-all duration-300 flex items-center justify-center space-x-3">' +
                                '<i class="fas fa-map-marked-alt text-lg"></i>' +
                                '<span>View on Map</span>' +
                            '</button>' +
                            '<button onclick="handleViewDashboard()" class="bg-gradient-to-br from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white px-6 py-4 rounded-xl font-semibold transition-all duration-300 flex items-center justify-center space-x-3">' +
                                '<i class="fas fa-tachometer-alt text-lg"></i>' +
                                '<span>Return to Dashboard</span>' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            
            console.log('Detail content updated successfully');
        }

        // Handle view ArcGIS - Using your actual data source ID
        function handleViewArcGIS(apn) {
            console.log('Handle view ArcGIS called for APN:', apn);
            
            // Using your actual data source ID: dataSource_5-c618cc10482c44689186cffcf8f4521a
            const url = 'https://experience.arcgis.com/experience/c69f053c68e84a0ab98bc80b00836949/#data_s=where:dataSource_5-c618cc10482c44689186cffcf8f4521a:geo_id=\'' + apn + '\'&zoom_to_selection=true';
            
            console.log('Opening URL with correct data source:', url);
            window.open(url, '_blank');
        }

        // Handle view county records
        function handleViewCounty(apn) {
            const url = 'https://whatcom.maps.arcgis.com/apps/webappviewer/index.html?id=f2f8eaa500b04f54948c680bb280129f&find=' + apn;
            window.open(url, '_blank');
        }

        // Handle view dashboard
        function handleViewDashboard() {
            showPortfolioOverview();
        }

        // Show portfolio overview
        function showPortfolioOverview() {
            currentView = 'overview';
            document.getElementById('portfolioOverview').style.display = 'block';
            document.getElementById('propertyListView').style.display = 'none';
            document.getElementById('propertyDetail').style.display = 'none';
        }

        // Show all properties
        function showAllProperties() {
            currentView = 'list';
            filteredProperties = allProperties.slice();
            renderPropertyList('All Properties');
        }

        // Show properties by category with CSV-specific phase filtering
        function showPropertiesByCategory(category) {
            currentView = 'list';
            if (category === 'Construction') {
                // Construction CSV phases: Sheetrock, Flatwork, Roof, Final
                filteredProperties = allProperties.filter(function(p) { 
                    return ['Sheetrock', 'Flatwork', 'Roof', 'Final'].includes(p.phase);
                });
                renderPropertyList('In Construction Properties');
            } else if (category === 'Completed') {
                // Completed CSV phases: Sold, Listed, Pending
                filteredProperties = allProperties.filter(function(p) { 
                    return ['Sold', 'Listed', 'Pending'].includes(p.phase);
                });
                renderPropertyList('Completed Properties');
            } else if (category === 'Upcoming') {
                // Upcoming CSV phases: Design, Delete (and any Hold/Unknown if they exist)
                filteredProperties = allProperties.filter(function(p) { 
                    return ['Design', 'Delete', 'Hold', 'Unknown'].includes(p.phase);
                });
                renderPropertyList('Upcoming Properties');
            }
        }

        // Render property list
        function renderPropertyList(title) {
            document.getElementById('portfolioOverview').style.display = 'none';
            document.getElementById('propertyListView').style.display = 'block';
            document.getElementById('propertyDetail').style.display = 'none';
            
            document.getElementById('listTitle').textContent = title;
            
            const grid = document.getElementById('propertiesGrid');
            grid.innerHTML = filteredProperties.map(function(property) { return createPropertyCard(property); }).join('');
        }

        // Go back function
        function goBack() {
            if (currentView === 'list') {
                showAllProperties();
            } else {
                showPortfolioOverview();
            }
        }

        // Search and filter functionality
        function setupSearchAndFilter() {
            const searchInput = document.getElementById('searchInput');
            const phaseFilter = document.getElementById('phaseFilter');
            
            function filterProperties() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedPhase = phaseFilter.value;
                
                const filtered = allProperties.filter(function(property) {
                    const matchesSearch = property.address.toLowerCase().indexOf(searchTerm) !== -1 || 
                                        property.apn.indexOf(searchTerm) !== -1 ||
                                        property.city.toLowerCase().indexOf(searchTerm) !== -1;
                    const matchesPhase = !selectedPhase || property.phase === selectedPhase;
                    return matchesSearch && matchesPhase;
                });
                
                filteredProperties = filtered;
                const grid = document.getElementById('propertiesGrid');
                grid.innerHTML = filteredProperties.map(function(property) { return createPropertyCard(property); }).join('');
            }
            
            searchInput.addEventListener('input', filterProperties);
            phaseFilter.addEventListener('change', filterProperties);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing enhanced application with', allProperties.length, 'properties');
            initializePhaseChart();
            setupSearchAndFilter();
            showPortfolioOverview();
        });
    </script>
</body>
</html>